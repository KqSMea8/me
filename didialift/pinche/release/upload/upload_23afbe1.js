define("upload/upload.js",function(t,e,i){var o=t("upload/imgcliper.js"),n=i.exports=function(t,e){var i="iframepost"+Math.floor(1e3*Math.random()),o=e.filekey||"file";this.opt=$.extend({outputWidth:500,outputHeight:500,data:{}},e),this.$el=t,this.fileInput=document.createElement("INPUT"),this.form=document.createElement("FORM"),this.iframe=document.createElement("IFRAME"),this.fileInput.name=o,this.fileInput.type="file",this.fileInput.setAttribute("accept","image/*"),this.fileInput.style.cssText="position: absolute;left:0;top:0;height:100%;width:100%; opacity: 0",this.form.target=i,this.form.method="POST",this.form.encoding="multipart/form-data",this.form.action=e.url,"undefined"==typeof FileReader&&(alert("非常抱歉，您的手机不支持文件上传，请更换手机注册，谢谢"),this.iframe.style.display="none",this.iframe.name=i,document.body.appendChild(this.iframe)),this.form.appendChild(this.fileInput),t.appendChild(this.form),this.register()};n.prototype={register:function(){var t=this;this.fileInput.addEventListener("change",function(e){t.onFileChange(e)},!1),this.iframe.addEventListener("load",function(){t.onsuccess(this.contentWindow.document.body.innerHTML)},!1)},onFileChange:function(t){var e=this,i=t.target.files[0];if(void 0!==i){var o=t.target.value.match(/\.(png|jpg|jpeg|gif)$/i)[1];this.fileInfo={ext:o,type:i.type,name:i.name,size:i.size},e.showLoading();var n=Math.max(Math.max(e.opt.outputWidth,e.opt.outputHeight),1e3);canvasResize(i,{width:n,height:n,crop:!1,quality:80,rotate:0,callback:function(t,i,o){e.closeLoading(),e.clip(t,i,o)}})}},clip:function(t,e,i){var n=this,a={clipWidth:n.opt.outputWidth,clipHeight:n.opt.outputHeight,originHeight:i,originWidth:e,fileType:n.fileInfo.type,rawData:t,onSave:function(t){n.showLoading(),n.compress({dataURL:t},function(t){n.upload(t)}),n.fileInput.value=""},onCancel:function(){n.fileInput.value="",n.opt.onCancelUpload&&n.opt.onCancelUpload()}};this.imgCliper&&this.imgCliper.destroy(),this.imgCliper=new o(a)},compress:function(t,e){var i=this;canvasResize(t,{fileType:i.fileInfo.type,width:i.opt.outputWidth,height:i.opt.outputHeight,crop:!1,quality:80,rotate:0,callback:function(t){e(t)}})},upload:function(t){var e=this,i=new FormData;i.append("file",t),i.append("type",e.fileInfo.type),i.append("size",e.fileInfo.size),i.append("filename",e.fileInfo.name),i.append("ext",e.fileInfo.ext),$.each(e.opt.data,function(t,e){i.append(t,e)}),i.append("filename",e.fileInfo.name+~~(1e6*Math.random()));var o=new XMLHttpRequest;o.open("POST",e.opt.url,!0),o.setRequestHeader("X-Requested-With","XMLHttpRequest"),o.setRequestHeader("pragma","no-cache"),o.upload.addEventListener("progress",function(t){t.lengthComputable;Math.ceil(t.loaded/t.total*100)},!1),o.onreadystatechange=function(){4===o.readyState&&(clearTimeout(n),200===o.status?e.onUploadSuccess(o.responseText):e.uploadFailed(o.responseText))};var n=setTimeout(function(){o.abort(),e.uploadFailed("timeout")},e.opt.timeout||2e4);o.send(i)},onUploadSuccess:function(t){this.imgCliper.close(),this.closeLoading(),this.opt.onSuccessUpload&&this.opt.onSuccessUpload(t)},uploadFailed:function(){this.opt.onFailedUpload&&this.opt.onFailedUpload()},showLoading:function(){window.dd&&window.dd.dialog&&window.dd.dialog.loading("正在加载",3e3)},closeLoading:function(){window.dd&&window.dd.dialog&&window.dd.dialog.loading("正在加载",0)}}});